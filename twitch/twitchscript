#!/bin/bash

# Parameters (See README.md)

channelsfile=/path/to/your/list/of/favorite/channel/file
gamesfile=/path/to/your/list/of/favorite/game/file
clientID=yourapikey
gamesdb=/path/to/your/game/database/file

nobodyshit(){
    echo "Nobody streaming this shit right now"
    noshit="No streams. Choose an other game:"
    twitchgamefunction
}

aborted(){
    echo "Aborted"
    exit
}

check_and_launch(){
    gametocheck=$(echo $@)
    gametocheck=$(python -c "print('$gametocheck'.replace(' ','%20'))")
    echo "Checking connected streams for $@ ..."

    twitchdata=$(curl -s 'https://api.twitch.tv/kraken/streams?client_id='$clientID'&game='$gametocheck)
    [[ $(echo $twitchdata | jq '._total') == 0 ]] && nobodyshit

    stream=$(echo $twitchdata | jq -r '.streams[] | .channel.language, .channel.name' | awk 'NR%2{printf "%s:",$0;next;}1' | dmenu -i -p "Which stream ?" | sed 's/.*://')
    [[ ! -n $stream ]] && aborted

    exec firefox -new-window https://www.twitch.tv/popout/$stream/chat?popout= & mpv https://www.twitch.tv/$stream
    exit
}

twitchgamefunction(){        
    if [[ -n $@ ]]; then
	check_and_launch $@
    else	
	game=$(awk '{print $0} END { printf "Other\nAdd" }' $gamesfile | dmenu -i -p "$noshit") || aborted
	if [[ $game == Add ]];then
0	    game=$(cat $gamesdb | dmenu -i -p "Which game do you want to add on favorite?") || aborted
	    echo -e "$game" >>$gamesfile
	    cert=$(echo -e "No\nYes" | dmenu -i -p "Do you want to check streams for $game?")
	    [[ $cert == Yes ]] || aborted
	elif [[ $game == Other ]]; then
	    game=$(cat $gamesdb| dmenu -i -p "$noshit") || aborted
	fi
	    check_and_launch $game
    fi
}

twitchlivefunction(){
    if [[ -n $@ ]]; then
	echo "Checking if $@ is live ..."
	test=$(curl -s https://api.twitch.tv/kraken/streams/"$@"?client_id=$clientID | jq ".stream._id")

	[ ! $test == null ] && (exec firefox -new-window https://www.twitch.tv/popout/$@/chat?popout= & mpv https://www.twitch.tv/"$@") || echo "$@ doesn't stream right now"
	exit
    else
	echo "Checking connected streams ..."
	twitchdata=$(curl -s 'https://api.twitch.tv/kraken/streams?client_id='$clientID'&channel='$(cat $channelsfile))

	stream=$(echo $twitchdata | jq -r '.streams[] | .channel.name' | dmenu -i -p "Which stream do you want to watch?") || aborted
	exec firefox -new-window https://www.twitch.tv/popout/$stream/chat?popout= & mpv https://www.twitch.tv/"$stream"
	exit
    fi
}

if ping -q -c 1 -W 1 8.8.8.8 &>/dev/null; then
    case $1 in
	--live)
	    twitchlivefunction $2
	    ;;
	--game)
	    noshit="Choose a game"
	    twitchgamefunction "${@#$1}"
	    ;;
	*)
	    echo Need an option \"--live\" or \"--game\"
	    ;;
    esac
else
    echo "No internet connection"
fi
